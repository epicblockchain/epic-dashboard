<html>
  <head>
    <meta charset="UTF-8">
    <title>ePIC Dashboard</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="node_modules/materialize-css/dist/css/materialize.min.css">
    <link rel="stylesheet" href="node_modules/material-icons/iconfont/material-icons.css">
  </head>
  
  <!-- sidenav -->
  <!-- todo fix this disappearing on very small screens -->
  <div>
    <ul id="nav" class="sidenav sidenav-fixed">
      <li>
        <div class="container">
          <img width="100%" src="img/EpicLogo-Vertical.png">
        </div>  
      </li>
      <li><div class="divider"></div></li>
      <li id="nav-dashboard" class="nav-selector grey lighten-2"><a class="waves-effect">Dashboard</a></li>
      <li id="nav-charts" class="nav-selector"><a class="waves-effect">Charts</a></li>
      <li id="nav-miners" class="nav-selector"><a class="waves-effect">Miners</a></li>
      <li id="nav-pools" class="nav-selector"><a class="waves-effect">Pools</a></li>
      <li id="nav-settings" class="nav-selector"><a class="waves-effect">Settings</a></li>
    </ul>
  </div>

  <div>
    <a id="btn-refresh" class="waves-effect waves-light btn right indigo darken-4 tooltipped" data-position="left" data-tooltip="Search for miners on network" style="margin: 20px;" href="#"><i class="material-icons">refresh</i></a>
  </div>

  <!-- pages -->
  <div style="margin-left: 125px;">
    <!-- dashboard page -->
    <div id="page-dashboard" class="container page">
      <div class="row">
        <div class="col s4">
          <div class="card indigo darken-4">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="total-hashrate" class="card-title">Loading...</span>
                <p>Total Hashrate</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card yellow accent-4">
            <div class="card-content">
              <div class="card-content">
                <span id="accepted-rejected-shares" class="card-title">Loading...</span>
                <p>Accepted / Rejected Shares</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card indigo darken-4">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="active-miners" class="card-title">Loading...</span>
                <p>Active Miners</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s4">
          <div class="card yellow accent-4">
            <div class="card-content">
              <div class="card-content">
                <span id="current-pool" class="card-title">Loading...</span>
                <p>Current Pool</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card indigo darken-4">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="avg-difficulty" class="card-title">Loading...</span>
                <p>Average Difficulty</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card yellow accent-4">
            <div class="card-content">
              <div class="card-content">
                <span id="last-accepted-share-time" class="card-title">Loading...</span>
                <p>Last Accepted Share Time</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- charts page -->
    
    <div id="page-charts" class="container hide page">
      <div class="row">
        <div class="col s12">
          <ul class="tabs indigo darken-4">
            <li id="tab-15m" class="tab col s3"><a  class="white-text" href="#">15 min</a></li>
            <li id="tab-2hr" class="tab col s3"><a  class="white-text" href="#">2 hr</a></li>
            <li id="tab-8hr" class="tab col s3"><a  class="white-text" href="#">8 hr</a></li>
            <li id="tab-24hr" class="tab col s3"><a class="white-text" href="#">24 hr</a></li>
          </ul>
        </div>
      </div>
        <canvas id="hashrate-chart" height="100%"></canvas>
        <canvas id="power-chart" height="100%"></canvas>
    </div>

    <!-- miners page -->
    <div id="page-miners" class="container hide page">
      <table class="centered">
        <thead>
          <tr id="miner-headers">
            <!-- gets auto filled -->
          </tr>
        </thead>
        <tbody id="miner-table-body">
          <!-- gets auto filled -->
        </tbody>
      </table>
    </div>

    <!-- pools page -->

    <!-- settings page -->

  </div>

  <!-- js stuff -->
  <script>
    window.jQuery = window.$ = require('jquery'); //jquery needs to be init like this because of node environment
  </script>
  <script src="node_modules/materialize-css/dist/js/materialize.min.js"></script>
  <script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
  <script src="node_modules/chartjs-plugin-streaming/dist/chartjs-plugin-streaming.js"></script> -->
  <script>
    //electron
    var e = require('electron');
    //to init the info and charts

    //materializecss inits
    //button
    $(document).ready(function(){
      $('.tooltipped').tooltip();
    });
    //research for miners
    $('#btn-refresh').click(function(){
      e.ipcRenderer.send('refresh');
    });
    e.ipcRenderer.on('refresh-reply', (event, arg) => {
      M.toast({html: 'Refreshed!'});
    })
    //sidebar
    document.addEventListener('DOMContentLoaded', function() {
      var instances = M.Sidenav.init();//elems, options
    });
    $(document).ready(function(){
      $('.sidenav').sidenav();
    });

    //nav logic to highlight nav selector and show/hide page elements
    $('.nav-selector').click(function(event){
      //navbar highlighting
      var selector_id = $(this)[0].id;
      $(".nav-selector").removeClass("grey lighten-2");
      $(this).addClass("grey lighten-2");
      //page hiding / showing
      $(".page").addClass('hide'); //make sure this doesnt add the same class twice
      $("#page-"+selector_id.substr(4)).removeClass('hide');
    });

    //dashboard
    e.ipcRenderer.on('dashboard-channel', (event, message) => {
      for (var id in message) {
        $('#'+id).html(message[id]);
      }
    });

    //chart see https://github.com/nagix/chartjs-plugin-streaming if lowering cpu usage is needed
    //also see https://github.com/chartjs/chartjs-plugin-zoom for zoom
    var ctx = document.getElementById('hashrate-chart').getContext('2d');
    var pctx = document.getElementById('power-chart').getContext('2d');
    var fs = require('fs');
    var requestInterval = JSON.parse(fs.readFileSync('settings.json')).requestInterval;

    var chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          data: [],
          label: 'Hashrate (TH/s)',
          borderColor: 'rgb(0, 0, 128)',
          backgroundColor: 'rgba(0, 0, 128, 0.5)'
        }]
      },
      options: {
        elements: {
          line: {
            tension: 0
          }
        },
        scales: {
          xAxes: [{
            type: 'realtime',
            realtime: {
              delay: requestInterval*1.5,
              duration: 900000
            }
          }],
          yAxes: [{
            ticks: {
              min: 0
            }
          }]
        }
      }
      });

    var pchart = new Chart(pctx, {
      type: 'line',
      data: {
        datasets: [{
          data: [],
          label: 'Power (W)',
          borderColor: 'rgb(240, 190, 0)',
          backgroundColor: 'rgba(255, 204, 0, 0.5)'
        }]
      },
      options: {
        elements: {
          line: {
            tension: 0
          }
        },
        scales: {
          xAxes: [{
            type: 'realtime',
            realtime: {
              delay: requestInterval*1.5,
              duration: 900000
            }
          }],
          yAxes: [{
            ticks: {
              min: 0
            }
          }]
        }
      }
      });


    $('.tab').click(function(){
      var id = $(this).attr('id');
      if (id == 'tab-24hr'){
        chart.options.scales.xAxes[0].realtime.duration = 43200000; //this is 24 hr in millis
        pchart.options.scales.xAxes[0].realtime.duration = 43200000; //this is 24 hr in millis
      } else if (id == 'tab-8hr'){
        chart.options.scales.xAxes[0].realtime.duration = 14400000;
        pchart.options.scales.xAxes[0].realtime.duration = 14400000;
      } else if (id == 'tab-2hr'){
        chart.options.scales.xAxes[0].realtime.duration = 3600000;
        pchart.options.scales.xAxes[0].realtime.duration = 3600000;
      } else {
        chart.options.scales.xAxes[0].realtime.duration = 900000;
        pchart.options.scales.xAxes[0].realtime.duration = 900000;
      }
    });
    
    e.ipcRenderer.on('chart-channel', (event, message) => {
      chart.data.datasets[0].data = message["hr-chart"];
      pchart.data.datasets[0].data = message["p-chart"];
    });

    //miners
    e.ipcRenderer.on('miners-channel', (event, message) => {
      $("#miner-headers").empty();
      message.headers.forEach(h => {
        $('#miner-headers').append('<th>'+h+'</th>');
      });
      $("#miner-table-body").empty();
      message.data.forEach(d => {
        var datumString = '<tr>';
        d.forEach(el => {
          if (el == "Disconnected") datumString+='<td colspan="'+message.headers.length+'">Disconnected</td>';
          else datumString+='<td style="max-width: 150px; word-wrap: break-word">'+el+'</td>';
        });
        datumString += '</tr>'
        $("#miner-table-body").append(datumString);
      });
    });

    // //pools
    // e.ipcRenderer.on('pools-channel', (event, message) => {
    //   console.log(message);
    // });

    // //settings
    // e.ipcRenderer.on('settings-channel', (event, message) => {
    //   console.log(message);
    // });

  </script>
  </body>
</html>

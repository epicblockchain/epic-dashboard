<html>
  <head>
    <meta charset="UTF-8">
    <title>ePIC Dashboard</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="node_modules/materialize-css/dist/css/materialize.min.css">
  </head>
  
  <!-- sidenav -->
  <!-- todo fix this disappearing on very small screens -->
  <div>
    <ul id="nav" class="sidenav sidenav-fixed">
      <li>
        <div class="container">
          <img width="100%" src="img/EpicLogo-Vertical.png">
        </div>  
      </li>
      <li><div class="divider"></div></li>
      <li id="nav-dashboard" class="nav-selector grey lighten-2"><a class="waves-effect">Dashboard</a></li>
      <li id="nav-charts" class="nav-selector"><a class="waves-effect">Charts</a></li>
      <li id="nav-miners" class="nav-selector"><a class="waves-effect">Miners</a></li>
      <li id="nav-pools" class="nav-selector"><a class="waves-effect">Pools</a></li>
      <li id="nav-settings" class="nav-selector"><a class="waves-effect">Settings</a></li>
    </ul>
  </div>

  <!-- pages -->
  <div style="margin-left: 125px;">
    <!-- dashboard page -->
    <div id="page-dashboard" class="container page">
      <div class="row">
        <div class="col s4">
          <div class="card blue">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="total-hashrate" class="card-title">Loading...</span>
                <p>Total Hashrate</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card red">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="accepted-rejected-shares" class="card-title">Loading...</span>
                <p>Accepted / Rejected Shares</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card green">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="active-miners" class="card-title">Loading...</span>
                <p>Active Miners</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col s4">
          <div class="card orange">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="current-pool" class="card-title">Loading...</span>
                <p>Current Pool</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card purple">
            <div class="card-content white-text">
              <div class="card-content white-text">
                <span id="avg-difficulty" class="card-title">Loading...</span>
                <p>Average Difficulty</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col s4">
          <div class="card yellow">
            <div class="card-content">
              <div class="card-content">
                <span id="last-accepted-share-time" class="card-title">Loading...</span>
                <p>Last Accepted Share Time</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- charts page -->
    <div id="page-charts" class="container hide page">
        <canvas id="hashrate-chart" width="100%" height="100%"></canvas>
    </div>

    <!-- miners page -->
    <div id="page-miners" class="hide page">
      <table class="centered" style="margin-left: 200px;">
        <thead>
          <tr id="miner-headers">
            <!-- gets auto filled -->
          </tr>
        </thead>
        <tbody id="miner-table-body">
          <!-- gets auto filled -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- js stuff -->
  <script>
    window.jQuery = window.$ = require('jquery'); //jquery needs to be init like this because of node environment
  </script>
  <script src="node_modules/materialize-css/dist/js/materialize.min.js"></script>
  <script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
  <script src="node_modules/chartjs-plugin-streaming/dist/chartjs-plugin-streaming.min.js"></script> -->
  <script>
    //to init the info and charts

    //materializecss inits
    //sidebar
    document.addEventListener('DOMContentLoaded', function() {
      var instances = M.Sidenav.init();//elems, options
    });
    $(document).ready(function(){
      $('.sidenav').sidenav();
    });

    //nav logic to highlight nav selector and show/hide page elements
    $('.nav-selector').click(function(event){
      //navbar highlighting
      var selector_id = $(this)[0].id;
      $(".nav-selector").removeClass("grey lighten-2");
      $(this).addClass("grey lighten-2");
      //page hiding / showing
      $(".page").addClass('hide'); //make sure this doesnt add the same class twice
      $("#page-"+selector_id.substr(4)).removeClass('hide');
    });

    var e = require('electron');
    //dashboard
    e.ipcRenderer.on('dashboard-channel', (event, message) => {
      for (var id in message) {
        $('#'+id).html(message[id]);
      }
    });

    //chart see https://github.com/nagix/chartjs-plugin-streaming if lowering cpu usage is needed
    //also see https://github.com/chartjs/chartjs-plugin-zoom for zoom
    
    var ctx = document.getElementById('hashrate-chart').getContext('2d');
    var chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          data: []
        }, {
          data: []
        }]
      },
      options: {
        scales: {
          xAxes: [{
            type: 'realtime',
            realtime: {
              onRefresh: function(chart) {
                chart.data.datasets.forEach(function(dataset) {
                  dataset.data.push({
                    x: Date.now(),
                    y: Math.random()
                  });
                });
              }
            }
          }]
        }
      }
      });

    e.ipcRenderer.on('chart-channel', (event, message) => {
      console.log('chart data received: ' + message);
    });

    //miners
    e.ipcRenderer.on('miners-channel', (event, message) => {
      $("#miner-headers").empty();
      message.headers.forEach(h => {
        $('#miner-headers').append('<th>'+h+'</th>');
      });
      $("#miner-table-body").empty();
      message.data.forEach(d => {
        var datumString = '<tr>';
        d.forEach(el => {
          if (el == "Disconnected") datumString+='<td colspan="'+message.headers.length+'">Disconnected</td>';
          else datumString+='<td style="max-width: 150px; word-wrap: break-word">'+el+'</td>';
        });
        datumString += '</tr>'
        $("#miner-table-body").append(datumString);
      });
    });

    //pools
    e.ipcRenderer.on('pools-channel', (event, message) => {
      console.log(message);
    });

    //settings
    e.ipcRenderer.on('settings-channel', (event, message) => {
      console.log(message);
    });

  </script>
  </body>
</html>
